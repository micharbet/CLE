##
## ** mod-ltmux: tmux live session wrapper **
#
#* version: 2022-10-19
#* author:  Michael Arbet (micharbet@gmail.com)
#* home:    https://github.com/micharbet/CLE
#* license: GNU GPL v2
#* Copyright (C) 2022 by Michael Arbet 
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.

# prepare user's configuration on workstation to transfer
if [ -z "$CLE_WS" ]; then
	cp $HOME/.tmux.conf $CLE_D/tmux.conf 2>/dev/null && CLE_XFILES="$CLE_XFILES tmux.conf"
fi

## `ltmux`     - live tmux session
ltmux () (
	[ $CLE_USER = $USER ] && CLE_TMNAME=$CLE_USER || CLE_TMNAME=$CLE_USER-$USER
	if tmux attach-session -t $CLE_TMNAME; then
		: only attaching
	else
		CLE_TMUX=$CLE_D/ltmux.conf
		# Create specific configuration that will:
		# 1. source all possible configurations (host defult, inherited, user's local)
		# 2. set CLE as the command of every new shell within ltmux
		cat <<-EOT >$CLE_TMUX
			source-file -q /etc/tmux.conf
			source-file -q $CLE_DR/tmux.conf${CLE_WS:+-$CLE_WS}
			source-file -q $HOME/.tmux.conf
			set -g default-command $CLE_RC
			set -g status-left-length 19
		EOT
		tmux -f $CLE_TMUX new-session -s $CLE_TMNAME "$@"
	fi
)

# Register ltmux for transfer to remote session
CLE_XFUN="$CLE_XFUN ltmux"

