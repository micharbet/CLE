##
## ** mod-ltmux: tmux live session wrapper **
#
#* version: 2023-02-15
#* author:  Michael Arbet (micharbet@gmail.com)
#* home:    https://github.com/micharbet/CLE
#* license: MIT
#* Copyright (C) 2022-2024 by Michael Arbet 

## `ltmux`     - live tmux session
ltmux () (
	# $CLE_USER-$USER is a way to determine one's session in multi-admin
	# environment E.g. remote root's session can be CLE_TMUX='mich-root'
	[ $CLE_USER = $USER ] && CLE_TMUX=$CLE_USER || CLE_TMUX=$CLE_USER-$USER
	# Attach an existing session ...
	tmux attach-session -t $CLE_TMUX || {
		# ... or open a new one
		CLE_TMUXCF=$CLE_D/ltmux.conf-main

		# Create minimal configuration that ensures:
		# 1. source all possible configurations (host defult, user's local
		#    and CLE-custom file)
		#    Note: the 'source-file -q' (quiet if no such file) does
		#    not work properly on older tmux versions. The '-q' may
		#    throw an error message.
		# 2. ensure running CLE for new widows and panes in ltmux
		{
			for F in /etc/tmux.conf $CLE_DR/ltmux.conf$CLE_WS $HOME/.tmux.conf; do
				[ -f $F ] && echo "source-file $F"
			done
			echo "set -g default-command $CLE_RC"
		} >$CLE_TMUXCF

		# Tmux versions need to be considered if one is using takeway file ($CLE_D/ltmux.conf)
		# An environment variable with tmux version multiplied by 100
		# can be used for decission within config file like follows:
		#   if-shell -b '[ $TMUX_VER -gt 210 ]' { set -g mouse on }
		export TMUX_VER=`echo $(tmux -V | sed -En "s/^tmux[^0-9]*([.0-9]+).*/\1/p") *100/1 | bc`
		# The workaround was inspired by: 
		# https://stackoverflow.com/questions/35016458/how-to-write-if-statement-in-tmux-conf-to-set-different-options-for-different-t
		# There are also other methods to write multi-version compatible tmux.conf:
		# https://blog.landofcrispy.com/index.php/2021/01/12/adjusting-tmux-conf-options-for-different-versions/

		# Start the tmux session
		tmux -f $CLE_TMUXCF new-session -s $CLE_TMUX "$@"
	}
)

# Register ltmux for transfer to remote session
CLE_XFUN="$CLE_XFUN ltmux"		#: CLE takeaway function
CLE_XFILES="$CLE_XFILES ltmux.conf" 	#: CLE takeaway file
