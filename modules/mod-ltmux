##
## ** mod-ltmux: tmux live session wrapper **
#
#* version: 2024-03-14
#* author:  Michael Arbet (micharbet@gmail.com)
#* home:    https://github.com/micharbet/CLE
#* license: MIT
#* Copyright (C) 2022-2024 by Michael Arbet 

## `ltmux`     - live tmux session
ltmux () (
	# $CLE_USER-$USER is a way to determine one's session in multi-admin
	# environment E.g. remote root's session can be CLE_TMUX='mich-root'
	[ $CLE_USER = $USER ] && CLE_TMUX=$CLE_USER || CLE_TMUX=$CLE_USER-$USER
	# Attach an existing session ...
	tmux attach-session -t $CLE_TMUX || {
		# ... or open a new one
		CLE_TMUXCF=$CLE_D/ltmux.conf-main

		# Create minimal configuration that ensures:
		# 1. source all possible configurations (host defult, user's local
		#    and CLE-custom file)
		#    Note: the 'source-file -q' (quiet if no such file) does
		#    not work properly on older tmux versions. The '-q' may
		#    throw an error message.
		# 2. ensure running CLE for new windows and panes in ltmux
		# 3. at least some colors (only blue for now)
		#    tuned for compatibility since ver 1.8
		{
			for F in /etc/tmux.conf $CLE_DR/ltmux.conf$CLE_WS $HOME/.tmux.conf; do
				[ -f $F ] && echo "source-file $F"
			done
			cat <<-EOCF
				set -g default-command $CLE_RC
				bind -rn BTab   select-window -n # Shift-Tab to switch windows (same as lscreen)
				set -g status-fg colour17
				set -g status-bg colour24
				set -g status-left-length 30
				set -g status-left "#[bg=colour31]#S "
				set -g status-right-length 30
				set -g status-right "#[bg=colour31] #h"
				set -g status-justify centre
				setw -g window-status-current-format "#[bg=colour32]#[fg=colour123]#I:#W#F"
			EOCF
		} >$CLE_TMUXCF

		# Tmux versions need to be considered if one is using takeway file ($CLE_D/ltmux.conf)
		# An environment variable with tmux version multiplied by 100
		# can be used for decission within config file like follows:
		#   if-shell -b '[ $TMUX_VER -gt 210 ]' { set -g mouse on }
		export TMUX_VER=`tmux -V | sed -En 's/^tmux[^0-9]*([.0-9]+).*/\1/p'`
		TMUX_VER=`awk "BEGIN { print $TMUX_VER * 100  }"`
		# The workaround for multi-version compatible tmux.conf
		# inspired by: 
		# https://stackoverflow.com/questions/35016458/how-to-write-if-statement-in-tmux-conf-to-set-different-options-for-different-t
		# Except 'awk' used for calculations instead of 'bc'
		# as this was found missing on base debian.
		# There are also other methods:
		# https://blog.landofcrispy.com/index.php/2021/01/12/adjusting-tmux-conf-options-for-different-versions/

		# Start the tmux session
		tmux -f $CLE_TMUXCF new-session -s $CLE_TMUX "$@"
	}
)

# Register ltmux for transfer to remote session
CLE_XFUN="$CLE_XFUN ltmux"		#: CLE takeaway function
CLE_XFILES="$CLE_XFILES ltmux.conf" 	#: CLE takeaway file
