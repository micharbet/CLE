##
## ** cle-ed: Tweak and config editor **
#
#* version: 2021-12-19
#* author:  Michael Arbet (marbet@redhat.com)
#* home:    https://github.com/micharbet/CLE
#* license: MIT
#* Copyright (C) 2018-2024 by Michael Arbet 


# `vii filename` -- edit file and keep backup
vii () {
	[ $1 ] || { echo vii: filename missing; return 1; }
	cp $1 $1.bk
	vi $1
}

local EDIR=$CLE_D/ed

# initialize basic shortcuts
if [ ! -d $EDIR ]; then
	mkdir -p $EDIR
	pushd $EDIR >/dev/null
	ln -s $CLE_TW tw
	ln -s ~/.cle-local local
	ln -s $CLE_CF cf
	ln -s ~/.bashrc bashrc
	ln -s ~/.profile profile
	ln -s ~/.vimrc vimrc
	ln -s ~/.ssh/config sshcf
	ln -s ~/.ssh/known-hosts sshkh
	popd >/dev/null
fi

case "$1" in
'')
	cle help "cle ed"
	echo " currently available shortcuts:"
	find $EDIR -type l -print | while read LINK; do
		printf "$_CL%15s$_CN -> %s\n" `basename $LINK` `readlink $LINK`
	done
	return
	;;
add)	## `cle ed add file [shortcut]` -- add file symlink for editing
	if [ ! -f $2 ]; then
		echo cle ed add: no such file $2
		if _cleask "create and edit now?";then
			touch $2
			vi $2
		else
			return 1
		fi
	fi
	# Normalize the path to file
	pushd `dirname $2` >/dev/null
	local FN=`basename $2`
	local SCUT=${3:-$FN}
	ln -sf $PWD/$FN $CLE_D/ed/$SCUT
	echo added:
	ls -l $CLE_D/ed/$SCUT
	echo "Now you can use 'cle ed $SCUT'"
	popd >/dev/null
	return 0
	;;
ls)	## `cle ed ls`                  -- list everything in the ed folder
	_clebold " Shortcuts in $EDIR:"
	ls -al $EDIR
	return
	;;
*)	## `cle ed shortcut_to_file`    -- edit a file, make backup
	local LINK=$EDIR/$1
	local FILE=`readlink $LINK`
	;;
esac

if [ $FILE ]; then
	echo ed: $FILE
	cp $LINK $LINK.bk 2>/dev/null
	vi $LINK
else
	echo unknown shortcut: $1
	return 1
fi

# Suggest restart if part of CLE was edited
[[ $FILE =~ cle- ]] && _cleask "Restart CLE?" && cle reload
return 0

