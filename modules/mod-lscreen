##
## ** mod-lscreen: GNU screen wrapper **
#
#* version: 2023-11-15
#* author:  Michael Arbet (marbet@redhat.com)
#* home:    https://github.com/micharbet/CLE
#* license: GNU GPL v2
#* Copyright (C) 2021-2023 by Michael Arbet 
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.

## `lscreen [name]`    - gnu screen wrapper, join your recent session or start new
## `lscreen -j [name]` - join other screen sessions, ev. search by name
#: GNU screen wrapper is here 1) because of there was no way to tell screen
#: program to start CLE on more than first window and, 2) to allow easily
#: join detached own session and/or join cooperative session with more
#: participants.
lscreen () (
	#: get name of the screen to search and join
	#: base of session name is $CLE_USER and this can be extended
	SN=CLE-$CLE_USER${1:+-$1}
	[ "$1" = -j ] && SN=${2:-.}
	#: list all screens with that name and find how many of them are there
	SCRS=`screen -ls|sed -n "/$SN/s/^[ \t]*\([0-9]*\.[^ \t]*\)[ \t]*.*/\1/p"`
	NS=`wc -w <<<$SCRS`
	reset #: sometimes it's necessary to reset terminal
	if [ $NS = 0 ]; then
		[ "$1" = -j ] && echo "No screen to join" && return 1
		#: No session with given name found, prepare to start new session
		SCF=$CLE_D/screenrc-main
		_clerh @ `tty` "screen -S $SN"
		# prepare own screenrc
		#: This generates nice configuration file with cool features:
		#:  - always visible status line with list of windows, hostname and clock
		#:  - feature to quickly switch using Ctrl+Left/Right Arrows
		#:  - reads good old $HOME/.screenrc
		#: Own screenrc file is necessary because otherwise it wouldn't start CLE in
		#: subsequent windows created with 'C-a C-c' (note the bind commands, above
		#: mentioned features are cool but this part is the important one)
		cat <<-EOS >$SCF
			source $HOME/.screenrc	# host local screenrc
			altscreen on
			autodetach on
			# enables shift-PgUp/PgDn
			termcapinfo xterm* ti@:te@
			# change window with alt-, and alt-. (means < and >)
			bindkey "^[," prev
			bindkey "^[." next
			defscrollback 9000
			hardstatus alwayslastline
			hardstatus string '%{= Kk} %-w%{Wk}%n %t%{-}%+w %-=%{+b Y}$CLE_SHN%{G} %c'
			# This is the most important for starting CLE in new windows
			bind c screen $CLE_RC
			bind ^c screen $CLE_RC
			# user's additions
			source $CLE_DR/screenrc-custom$CLE_WS	# custom file
			$CLE_SCRC	# content of a variable that can be set in tweak file

		EOS
		screen -c $SCF -S $SN $CLE_RC
	else
		#: is there only one such session or more?
		if [ $NS = 1 ]; then SN=$SCRS
		else
			#: we found more screens with simiilar names, choose one!
			_clebold "${_CU}Current '$SN' sessions:"
			PS3="$_CL choose # to join: $_CN"
			select SN in $SCRS;do
				[ $SN ] && break
			done
		fi
		_clerh @ `tty` "screen -x $SN"
		screen -S $SN -X echo "$CLE_USER joining" #: alert to the original session
		screen -x $SN
	fi
)

# register lscreen function and custom file for transfer to remote sessions
CLE_XFUN="$CLE_XFUN lscreen"
CLE_XFILES="$CLE_XFILES screenrc-custom"

